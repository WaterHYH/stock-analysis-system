<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'K线图 - ' + ${symbol}">股票K线图</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
        }
        
        .header .symbol-info {
            font-size: 16px;
            color: #666;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: #0056b3;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #kline-chart {
            width: 100%;
            height: 700px;
        }
        
        .no-data {
            text-align: center;
            padding: 100px 20px;
            color: #666;
            font-size: 18px;
        }
        
        .stock-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stock-search input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }
        
        .stock-search button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .stock-search button:hover {
            background: #218838;
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1>股票K线图</h1>
        <span class="symbol-info" th:text="'股票代码: ' + ${symbol}">股票代码: sh600000</span>
    </div>
    
    <div class="stock-search">
        <input type="text" id="symbolInput" placeholder="输入股票代码" th:value="${symbol}">
        <button onclick="goToKLine()">查看K线</button>
    </div>
    
    <div class="nav-links">
        <a th:href="@{/stocks}">股票列表</a>
        <a th:href="@{/stock-history}">历史数据</a>
    </div>
</div>

<div class="chart-container">
    <div th:if="${#lists.isEmpty(historyData)}" class="no-data">
        <p>暂无该股票的历史数据</p>
        <p style="margin-top: 10px; font-size: 14px; color: #999;">请确认股票代码是否正确（如 sh600000, sz000001）</p>
    </div>
    
    <div th:unless="${#lists.isEmpty(historyData)}" id="kline-chart"></div>
</div>

<script th:inline="javascript">
    // 跳转到K线图页面
    function goToKLine() {
        var symbol = document.getElementById('symbolInput').value.trim();
        if (symbol) {
            window.location.href = '/stock-history/kline/' + symbol;
        }
    }
    
    // 回车键提交
    document.getElementById('symbolInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            goToKLine();
        }
    });
    
    /*<![CDATA[*/
    var historyData = /*[[${historyData}]]*/ [];
    
    if (historyData && historyData.length > 0) {
        // 准备数据
        var dates = [];
        var klineData = [];  // [open, close, low, high]
        var volumes = [];
        var ma5Data = [];
        var ma10Data = [];
        var ma30Data = [];
        var ma60Data = [];
        var changePercentData = [];
        
        historyData.forEach(function(item) {
            dates.push(item.day);
            // ECharts K线图数据格式: [open, close, low, high]
            klineData.push([item.open, item.close, item.low, item.high]);
            volumes.push(item.volume);
            ma5Data.push(item.maPrice5 || null);
            ma10Data.push(item.maPrice10 || null);
            ma30Data.push(item.maPrice30 || null);
            ma60Data.push(item.maPrice60 || null);
            changePercentData.push(item.changePercent || null);
        });
        
        // 初始化图表
        var chartDom = document.getElementById('kline-chart');
        var myChart = echarts.init(chartDom);
        
        var option = {
            title: {
                text: /*[[${symbol}]]*/ 'K线图',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function(params) {
                    var dataIndex = params[0].dataIndex;
                    var result = params[0].axisValue + '<br/>';
                    
                    // 显示涨跌幅
                    var changePercent = changePercentData[dataIndex];
                    if (changePercent != null) {
                        var color = changePercent >= 0 ? '#ef5350' : '#26a69a';
                        var sign = changePercent >= 0 ? '+' : '';
                        result += '<span style="color:' + color + ';font-weight:bold;">涨跌幅: ' + sign + changePercent.toFixed(2) + '%</span><br/>';
                    }
                    
                    params.forEach(function(param) {
                        if (param.seriesType === 'candlestick') {
                            result += '开盘: ' + param.data[1].toFixed(2) + '<br/>';
                            result += '收盘: ' + param.data[2].toFixed(2) + '<br/>';
                            result += '最低: ' + param.data[3].toFixed(2) + '<br/>';
                            result += '最高: ' + param.data[4].toFixed(2) + '<br/>';
                        } else if (param.seriesType === 'bar') {
                            result += '成交量: ' + (param.data / 10000).toFixed(2) + '万<br/>';
                        } else if (param.seriesType === 'line' && param.data != null) {
                            result += param.seriesName + ': ' + param.data.toFixed(2) + '<br/>';
                        }
                    });
                    return result;
                }
            },
            legend: {
                data: ['K线', 'MA5', 'MA10', 'MA30', 'MA60'],
                top: 30
            },
            grid: [
                {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    height: '55%'
                },
                {
                    left: '10%',
                    right: '10%',
                    top: '70%',
                    height: '18%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    gridIndex: 0,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: {
                        formatter: function(value) {
                            return value.substring(5);  // 只显示月-日
                        }
                    }
                },
                {
                    type: 'category',
                    data: dates,
                    gridIndex: 1,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { show: false }
                }
            ],
            yAxis: [
                {
                    type: 'value',
                    gridIndex: 0,
                    scale: true,
                    splitNumber: 5,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#f0f0f0' } },
                    axisLabel: {
                        formatter: function(value) {
                            return value.toFixed(2);
                        }
                    }
                },
                {
                    type: 'value',
                    gridIndex: 1,
                    scale: true,
                    splitNumber: 2,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#f0f0f0' } },
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 80,
                    end: 100
                },
                {
                    type: 'slider',
                    xAxisIndex: [0, 1],
                    start: 80,
                    end: 100,
                    top: '92%',
                    height: 20
                }
            ],
            series: [
                {
                    name: 'K线',
                    type: 'candlestick',
                    data: klineData,
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    itemStyle: {
                        color: '#ef5350',      // 阳线填充色（红）
                        color0: '#26a69a',     // 阴线填充色（绿）
                        borderColor: '#ef5350', // 阳线边框色
                        borderColor0: '#26a69a' // 阴线边框色
                    }
                },
                {
                    name: 'MA5',
                    type: 'line',
                    data: ma5Data,
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    smooth: true,
                    lineStyle: { width: 1 },
                    symbol: 'none',
                    itemStyle: { color: '#9e9e9e' }  // 灰色
                },
                {
                    name: 'MA10',
                    type: 'line',
                    data: ma10Data,
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    smooth: true,
                    lineStyle: { width: 1 },
                    symbol: 'none',
                    itemStyle: { color: '#2196f3' }  // 蓝色
                },
                {
                    name: 'MA30',
                    type: 'line',
                    data: ma30Data,
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    smooth: true,
                    lineStyle: { width: 1 },
                    symbol: 'none',
                    itemStyle: { color: '#ff9800' }  // 橙色
                },
                {
                    name: 'MA60',
                    type: 'line',
                    data: ma60Data,
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    smooth: true,
                    lineStyle: { width: 1.5, type: 'dashed' },
                    symbol: 'none',
                    itemStyle: { color: '#9c27b0' }  // 紫色
                },
                {
                    name: '成交量',
                    type: 'bar',
                    data: volumes,
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: function(params) {
                            // 根据涨跌设置颜色
                            var kData = klineData[params.dataIndex];
                            return kData[1] >= kData[0] ? '#ef5350' : '#26a69a';
                        }
                    }
                }
            ]
        };
        
        myChart.setOption(option);
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }
    /*]]>*/
</script>

</body>
</html>
